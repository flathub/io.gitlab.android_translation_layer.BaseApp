id: io.gitlab.android_translation_layer.BaseApp
runtime: org.gnome.Platform
runtime-version: '49'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk17
# default command and finish-args only for using as commandline application. They are ignored when used as base app
command: android-translation-layer
finish-args:
  - --share=network
  - --share=ipc
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --socket=pulseaudio
  - --filesystem=home
cleanup:
  - /include
  - /bin/dx
  - '*.a'
  - '*.la'
  - /lib/libopenxr_loader.so*
  - /lib/libportal-*
  - /lib/cmake
  - /lib/girepository-1.0
  - /lib/java/core-all_classes.jar
  - /lib/java/core-junit_classes.jar
  - /lib/java/junit-runner_classes.jar
  - /lib/java/dx.jar
  - /lib/pkgconfig
  - /share/doc
  - /share/gir-1.0
  - /share/man
  - /share/vala
  - /etc/ssl/certs/java/cacerts.bks
modules:
  - name: libmd
    buildsystem: autotools
    sources:
      - type: archive
        url: https://libbsd.freedesktop.org/releases/libmd-1.1.0.tar.xz
        sha256: 1bd6aa42275313af3141c7cf2e5b964e8b1fd488025caf2f971f43b00776b332
        x-checker-data:
          type: anitya
          project-id: 15525
          stable-only: true
          url-template: https://libbsd.freedesktop.org/releases/libmd-$version.tar.xz

  - name: libbsd
    sources:
      - type: archive
        url: https://libbsd.freedesktop.org/releases/libbsd-0.12.2.tar.xz
        sha256: b88cc9163d0c652aaf39a99991d974ddba1c3a9711db8f1b5838af2a14731014
        x-checker-data:
          type: anitya
          project-id: 1567
          stable-only: true
          url-template: https://libbsd.freedesktop.org/releases/libbsd-$version.tar.xz

  - name: libportal
    buildsystem: meson
    sources:
      - type: archive
        url: https://github.com/flatpak/libportal/archive/0.9.1.tar.gz
        sha256: ea422b789ae487e04194d387bea031fd7485bf88a18aef8c767f7d1c29496a4e
        x-checker-data:
          type: anitya
          project-id: 230124
          stable-only: true
          url-template: https://github.com/flatpak/libportal/archive/$version.tar.gz

  - name: openxr
    buildsystem: cmake-ninja
    sources:
      - type: git
        url: https://github.com/KhronosGroup/OpenXR-SDK.git
        tag: release-1.1.54
    config-opts:
      - -DCMAKE_INSTALL_LIBDIR=lib

  - name: wolfssl
    buildsystem: autotools
    config-opts:
      - --enable-shared
      - --disable-opensslall
      - --disable-opensslextra
      - --enable-aescbc-length-checks
      - --enable-curve25519
      - --enable-ed25519
      - --enable-ed25519-stream
      - --enable-oldtls
      - --enable-base64encode
      - --enable-tlsx
      - --enable-scrypt
      - --disable-examples
      - --enable-crl
      - --enable-jni
      - --enable-sessioncerts
    sources:
      - type: git
        url: https://github.com/wolfSSL/wolfssl.git
        tag: v5.8.4-stable

  - name: vixl
    buildsystem: meson
    build-options:
      config-opts:
        - -Dsimulator=none
    only-arches:
      - aarch64
    sources:
      - type: archive
        url: https://github.com/Linaro/vixl/archive/refs/tags/8.0.0.tar.gz
        sha256: 6aebbebcd9b66686ea246b450af529e1fc50fe25209522cc9ab42beae2377d38
      - type: patch
        path: patches/vixl_meson_support.patch

  - name: bionic_translation
    buildsystem: meson
    sources:
      - type: git
        url: https://gitlab.com/android_translation_layer/bionic_translation.git
        commit: 5c31d4366fbb0af70690e72e5a861e7b44ffb1ef
        disable-submodules: true

  - name: art_standalone
    no-autogen: true
    build-options:
      make-args:
        - ____PREFIX=/app
        - ____LIBDIR=lib
      make-install-args:
        - ____PREFIX=/app
        - ____LIBDIR=lib
        - ____INSTALL_ETC=/app/etc
      append-path: /usr/lib/sdk/openjdk17/bin
      env:
        JAVA_HOME: /usr/lib/sdk/openjdk17/jvm/openjdk-17
        LIBRARY_PATH: /app/lib
    sources:
      - type: git
        url: https://gitlab.com/android_translation_layer/art_standalone.git
        commit: e78bf68917bcaaf58fef3960cd88793b3b7f39cc

  - name: android-translation-layer
    buildsystem: meson
    build-options:
      append-path: /usr/lib/sdk/openjdk17/bin
      env:
        JAVA_HOME: /usr/lib/sdk/openjdk17/jvm/openjdk-17
    sources:
      - type: git
        url: https://gitlab.com/android_translation_layer/android_translation_layer.git
        commit: 6735b824c2e80889d5f81536338246bf0cebd2c4
      - type: patch
        path: patches/android_translation_layer_appid.patch

  - name: cacerts
    buildsystem: simple
    build-commands:
      - mkdir -p /app/share/java_home/lib/security
      - install -D /usr/lib/sdk/openjdk17/jvm/openjdk-17/lib/security/cacerts /app/share/ssl/certs/java/cacerts

  - name: libopensles-standalone
    buildsystem: meson
    build-options:
      append-path: /usr/lib/sdk/openjdk17/bin
      env:
        JAVA_HOME: /usr/lib/sdk/openjdk17/jvm/openjdk-17
    sources:
      - type: git
        url: https://gitlab.com/android_translation_layer/libopensles-standalone
        commit: bdb857a4baadbc8c036db85a5da26c5269a751c5

  - name: run-dex2oat
    buildsystem: simple
    build-options:
      append-ld-library-path: /app/lib/art:/app/lib
      arch:
        x86_64:
          env:
            arch: x86_64
        aarch64:
          env:
            arch: arm64
    build-commands:
      - mkdir -p /app/lib/java/dex/art/oat/$arch
      - dex2oat -j1 --image=/app/lib/java/dex/art/oat/$arch/boot.art --dex-file=/app/lib/java/dex/art/core-oj-hostdex.jar
        --dex-location=/app/lib/java/dex/art/core-oj-hostdex.jar --dex-file=/app/lib/java/dex/art/apachehttp-hostdex.jar
        --dex-location=/app/lib/java/dex/art/apachehttp-hostdex.jar --dex-file=/app/lib/java/dex/art/apache-xml-hostdex.jar
        --dex-location=/app/lib/java/dex/art/apache-xml-hostdex.jar --dex-file=/app/lib/java/dex/art/bouncycastle-hostdex.jar
        --dex-location=/app/lib/java/dex/art/bouncycastle-hostdex.jar --dex-file=/app/lib/java/dex/art/core-junit-hostdex.jar
        --dex-location=/app/lib/java/dex/art/core-junit-hostdex.jar --dex-file=/app/lib/java/dex/art/core-libart-hostdex.jar
        --dex-location=/app/lib/java/dex/art/core-libart-hostdex.jar --dex-file=/app/lib/java/dex/art/hamcrest-hostdex.jar
        --dex-location=/app/lib/java/dex/art/hamcrest-hostdex.jar --dex-file=/app/lib/java/dex/art/junit-runner-hostdex.jar
        --dex-location=/app/lib/java/dex/art/junit-runner-hostdex.jar --dex-file=/app/lib/java/dex/art/okhttp-hostdex.jar
        --dex-location=/app/lib/java/dex/art/okhttp-hostdex.jar --dex-file=/app/lib/java/dex/art/wolfssljni-hostdex.jar
        --dex-location=/app/lib/java/dex/art/wolfssljni-hostdex.jar --oat-file=/app/lib/java/dex/art/oat/$arch/boot.oat
        --base=0x60cf8000 --host
      # mark it as executable, so that flatpak builder extracts debug info automatically
      - chmod +x /app/lib/java/dex/art/oat/$arch/*.oat
      - mkdir -p /app/lib/java/dex/android_translation_layer/oat/$arch
      - dex2oat --dex-file=/app/lib/java/dex/android_translation_layer/api-impl.jar
        --oat-file=/app/lib/java/dex/android_translation_layer/oat/$arch/api-impl.odex
        --host
      # mark it as executable, so that flatpak builder extracts debug info automatically
      - chmod +x /app/lib/java/dex/android_translation_layer/oat/$arch/*.odex

  - name: strip-jars
    buildsystem: simple
    build-commands:
      - for f in /app/lib/java/dex/art/*.jar /app/lib/java/dex/android_translation_layer/*.jar;
        do echo stripping $f; mv $f tmp.jar; zip -d tmp.jar "classes*.dex"; mv tmp.jar
        $f; done
